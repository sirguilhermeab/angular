{"version":3,"file":"angular-architects-module-federation-runtime.mjs","sources":["../../../../libs/mf-runtime/src/lib/loader/dynamic-federation.ts","../../../../libs/mf-runtime/src/angular-architects-module-federation-runtime.ts"],"sourcesContent":["type Scope = unknown;\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\ntype Factory = () => any;\n\ntype Container = {\n  init(shareScope: Scope): void;\n  get(module: string): Factory;\n};\n\nlet config: Manifest = {};\n\nexport type ManifestFile<T extends RemoteConfig = RemoteConfig> = {\n  [key: string]: string | T;\n};\n\nexport type Manifest<T extends RemoteConfig = RemoteConfig> = {\n  [key: string]: T;\n};\n\nexport type RemoteConfig = {\n  type: 'module' | 'script';\n  remoteEntry: string;\n  [key: string]: unknown;\n};\n\ndeclare const __webpack_init_sharing__: (shareScope: string) => Promise<void>;\ndeclare const __webpack_share_scopes__: { default: Scope };\n\ntype ContainerMap = { [key: string]: Container };\n\nconst containerMap: ContainerMap = {};\nconst remoteMap = {};\n\nlet isDefaultScopeInitialized = false;\n\nasync function lookupExposedModule<T>(\n  key: string,\n  exposedModule: string\n): Promise<T> {\n  const container = containerMap[key];\n  const factory = await container.get(exposedModule);\n  const Module = factory();\n  return Module as T;\n}\n\nasync function initRemote(container: Container, key: string) {\n  // const container = window[key] as Container;\n\n  // Do we still need to initialize the remote?\n  if (remoteMap[key]) {\n    return container;\n  }\n\n  // Do we still need to initialize the share scope?\n  if (!isDefaultScopeInitialized) {\n    await __webpack_init_sharing__('default');\n    isDefaultScopeInitialized = true;\n  }\n\n  await container.init(__webpack_share_scopes__.default);\n  remoteMap[key] = true;\n  return container;\n}\n\nexport type LoadRemoteEntryOptions =\n  | LoadRemoteEntryScriptOptions\n  | LoadRemoteEntryEsmOptions;\n\nexport type LoadRemoteEntryScriptOptions = {\n  type?: 'script';\n  remoteEntry: string;\n  remoteName: string;\n};\n\nexport type LoadRemoteEntryEsmOptions = {\n  type: 'module';\n  remoteEntry: string;\n};\n\nexport async function loadRemoteEntry(\n  remoteEntry: string,\n  remoteName: string\n): Promise<void>;\nexport async function loadRemoteEntry(\n  options: LoadRemoteEntryOptions\n): Promise<void>;\nexport async function loadRemoteEntry(\n  remoteEntryOrOptions: string | LoadRemoteEntryOptions,\n  remoteName?: string\n): Promise<void> {\n  if (typeof remoteEntryOrOptions === 'string') {\n    const remoteEntry = remoteEntryOrOptions;\n    return await loadRemoteScriptEntry(remoteEntry, remoteName);\n  } else if (remoteEntryOrOptions.type === 'script') {\n    const options = remoteEntryOrOptions;\n    return await loadRemoteScriptEntry(options.remoteEntry, options.remoteName);\n  } else if (remoteEntryOrOptions.type === 'module') {\n    const options = remoteEntryOrOptions;\n    await loadRemoteModuleEntry(options.remoteEntry);\n  }\n}\n\nasync function loadRemoteModuleEntry(remoteEntry: string): Promise<void> {\n  if (containerMap[remoteEntry]) {\n    return Promise.resolve();\n  }\n  return await import(/* webpackIgnore:true */ remoteEntry).then(\n    (container) => {\n      initRemote(container, remoteEntry);\n      containerMap[remoteEntry] = container;\n    }\n  );\n}\n\nasync function loadRemoteScriptEntry(\n  remoteEntry: string,\n  remoteName: string\n): Promise<void> {\n  return new Promise<void>((resolve, reject) => {\n    // Is remoteEntry already loaded?\n    if (containerMap[remoteName]) {\n      resolve();\n      return;\n    }\n\n    const script = document.createElement('script');\n    script.src = remoteEntry;\n\n    script.onerror = reject;\n\n    script.onload = () => {\n      const container = window[remoteName] as Container;\n      initRemote(container, remoteName);\n      containerMap[remoteName] = container;\n      resolve();\n    };\n\n    document.body.appendChild(script);\n  });\n}\n\nexport type LoadRemoteModuleOptions =\n  | LoadRemoteModuleScriptOptions\n  | LoadRemoteModuleEsmOptions\n  | LoadRemoteModuleManifestOptions;\n\nexport type LoadRemoteModuleScriptOptions = {\n  type?: 'script';\n  remoteEntry?: string;\n  remoteName: string;\n  exposedModule: string;\n};\n\nexport type LoadRemoteModuleEsmOptions = {\n  type: 'module';\n  remoteEntry: string;\n  exposedModule: string;\n};\n\nexport type LoadRemoteModuleManifestOptions = {\n  type: 'manifest';\n  remoteName: string;\n  exposedModule: string;\n};\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport async function loadRemoteModule<T = any>(remoteName: string, exposedModule: string): Promise<T>;\nexport async function loadRemoteModule<T = any>(options: LoadRemoteModuleOptions): Promise<T>\nexport async function loadRemoteModule<T = any>(\n  optionsOrRemoteName: LoadRemoteModuleOptions | string,\n  exposedModule?: string\n): Promise<T> {\n  let loadRemoteEntryOptions: LoadRemoteEntryOptions;\n  let key: string;\n  let remoteEntry: string;\n  let options: LoadRemoteModuleOptions;\n\n  if (typeof optionsOrRemoteName === 'string') {\n    options = {\n      type: 'manifest',\n      remoteName: optionsOrRemoteName,\n      exposedModule: exposedModule\n    }\n  }\n  else {\n    options = optionsOrRemoteName;\n  }\n\n  // To support legacy API (< ng 13)\n  if (!options.type) {\n    const hasManifest = Object.keys(config).length > 0;\n    options.type = hasManifest ? 'manifest' : 'script';\n  }\n\n  if (options.type === 'manifest') {\n    const manifestEntry = config[options.remoteName];\n    if (!manifestEntry) {\n      throw new Error('Manifest does not contain ' + options.remoteName);\n    }\n    options = {\n      type: manifestEntry.type,\n      exposedModule: options.exposedModule,\n      remoteEntry: manifestEntry.remoteEntry,\n      remoteName:\n        manifestEntry.type === 'script' ? options.remoteName : undefined,\n    };\n    remoteEntry = manifestEntry.remoteEntry;\n  } else {\n    remoteEntry = options.remoteEntry;\n  }\n\n  if (options.type === 'script') {\n    loadRemoteEntryOptions = {\n      type: 'script',\n      remoteEntry: options.remoteEntry,\n      remoteName: options.remoteName,\n    };\n    key = options.remoteName;\n  } else if (options.type === 'module') {\n    loadRemoteEntryOptions = {\n      type: 'module',\n      remoteEntry: options.remoteEntry,\n    };\n    key = options.remoteEntry;\n  }\n\n  if (remoteEntry) {\n    await loadRemoteEntry(loadRemoteEntryOptions);\n  }\n\n  return await lookupExposedModule<T>(key, options.exposedModule);\n}\n\nexport async function setManifest(\n  manifest: ManifestFile,\n  skipRemoteEntries = false\n) {\n  config = parseConfig(manifest);\n\n  if (!skipRemoteEntries) {\n    await loadRemoteEntries();\n  }\n}\n\nexport function getManifest<T extends Manifest>(): T {\n  return config as T;\n}\n\nexport async function initFederation(manifest: string | ManifestFile, skipRemoteEntries = false): Promise<void> {\n  if (typeof manifest === 'string') {\n    return loadManifest(manifest, skipRemoteEntries);\n  }\n  else {\n    return setManifest(manifest, skipRemoteEntries);\n  }\n}\n\nexport async function loadManifest(\n  configFile: string,\n  skipRemoteEntries = false\n): Promise<void> {\n  const result = await fetch(configFile);\n\n  if (!result.ok) {\n    throw Error('could not load configFile: ' + configFile);\n  }\n\n  config = parseConfig(await result.json());\n\n  if (!skipRemoteEntries) {\n    await loadRemoteEntries();\n  }\n}\n\nfunction parseConfig(config: ManifestFile): Manifest {\n  const result: Manifest = {};\n  for (const key in config) {\n    const value = config[key];\n\n    let entry: RemoteConfig;\n    if (typeof value === 'string') {\n      entry = {\n        remoteEntry: value,\n        type: 'module',\n      };\n    } else {\n      entry = {\n        ...value,\n        type: value.type || 'module',\n      };\n    }\n\n    result[key] = entry;\n  }\n  return result;\n}\n\nasync function loadRemoteEntries() {\n  const promises: Promise<void>[] = [];\n\n  for (const key in config) {\n    const entry = config[key];\n\n    if (entry.type === 'module') {\n      promises.push(\n        loadRemoteEntry({ type: 'module', remoteEntry: entry.remoteEntry })\n      );\n    } else {\n      promises.push(\n        loadRemoteEntry({\n          type: 'script',\n          remoteEntry: entry.remoteEntry,\n          remoteName: key,\n        })\n      );\n    }\n  }\n\n  await Promise.all(promises);\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":[],"mappings":"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"}